---
# CodeRabbit Configuration for Conceive-Do Full Codebase Analysis
# Analysis focus: Security, Critical Bugs, Performance
# Special attention: Edge Functions, Webhooks, Authentication, Sensitive Data, AI Auto-Reply

language: "fr"  # French language for review comments

reviews:
  # Enable comprehensive analysis for all file types
  profile: "balanced"

  # Request changes for critical issues
  request_changes_workflow: true

  # High-level summary for each category
  high_level_summary: true
  high_level_summary_placeholder: "## üìä Analyse CodeRabbit - Conceive-Do\n\nAnalyse compl√®te de 14k lignes avant d√©ploiement Vercel.\nFocus: S√©curit√© | Bugs Critiques | Performance"

  # Organize reviews by category
  auto_review:
    enabled: true
    auto_incremental_review: false  # Full review, not incremental
    ignore_title_keywords:
      - "WIP"
      - "DO NOT REVIEW"

    # Structured analysis by domain
    labels:
      - "coderabbit-security"      # Security issues
      - "coderabbit-bugs"          # Critical bugs
      - "coderabbit-performance"   # Performance concerns
      - "coderabbit-edge-functions" # Edge functions specific
      - "coderabbit-webhooks"      # Webhook handling
      - "coderabbit-auth"          # Authentication/authorization
      - "coderabbit-sensitive-data" # Data privacy/security
      - "coderabbit-ai"            # AI auto-reply concerns

    # Tool configurations for deep analysis
    tools:
      shellcheck:
        enabled: false

      ruff:
        enabled: false

      markdownlint:
        enabled: false

      github-checks:
        enabled: true
        timeout_ms: 90000  # 90 seconds for large codebase

      languagetool:
        enabled: false

      biome:
        enabled: false

      hadolint:
        enabled: false

      swiftlint:
        enabled: false

      phpstan:
        enabled: false

      golangci-lint:
        enabled: false

      yamllint:
        enabled: true

      eslint:
        enabled: true  # Use project's ESLint config

      gitleaks:
        enabled: true  # Scan for secrets and sensitive data

      semgrep:
        enabled: true  # Security pattern matching

  # Path-based instructions for focused analysis
  path_instructions:
    # Edge Functions - Critical Security Focus
    - path: "supabase/functions/**/*.ts"
      instructions: |
        üî¥ PRIORIT√â MAXIMALE - Edge Functions Supabase

        Analyser STRICTEMENT:
        1. **S√©curit√©**:
           - Validation des inputs (injection SQL, XSS, SSRF)
           - Gestion des secrets et variables d'environnement
           - Rate limiting et protection DoS
           - CORS et headers de s√©curit√©
           - Authentification JWT (v√©rifier config.toml)

        2. **Gestion d'erreurs**:
           - Try-catch appropri√©s
           - Pas de leak d'informations sensibles dans les erreurs
           - Logging s√©curis√©

        3. **Performance**:
           - Timeouts configur√©s
           - Gestion m√©moire pour gros payloads
           - Optimisation des requ√™tes DB

        4. **Code Quality**:
           - Type safety TypeScript
           - Gestion des promises et async/await
           - Pas de code mort ou debug statements

    # Webhook Handlers - Special Attention
    - path: "supabase/functions/evolution-webhook-handler/**"
      instructions: |
        üî¥ CRITIQUE - Webhook Handler Principal

        V√©rifier:
        1. Validation HMAC/signature webhook
        2. Idempotence (replay attacks)
        3. Rate limiting strict
        4. Timeout handling
        5. Payload size limits
        6. Error handling sans r√©v√©ler l'architecture
        7. Logging appropri√© (pas de donn√©es sensibles)

    - path: "supabase/functions/diagnose-webhook/**"
      instructions: |
        ‚ö†Ô∏è Webhook Diagnostics - S√©curit√©

        S'assurer:
        1. Pas d'exposition de credentials
        2. Limitation d'acc√®s appropri√©e
        3. Pas de verbose logging en production

    - path: "supabase/functions/set-webhook/**"
      instructions: |
        üî¥ CRITIQUE - Configuration Webhook

        V√©rifier:
        1. Validation URL webhook (SSRF prevention)
        2. HTTPS obligatoire
        3. Auth token s√©curis√©
        4. Pas de webhook vers localhost/internal IPs

    # AI Auto-Reply - Critical Analysis
    - path: "supabase/functions/ai-auto-reply/**"
      instructions: |
        üî¥ PRIORIT√â MAXIMALE - AI Auto-Reply

        Analyser en d√©tail:
        1. **Injection Prompts**:
           - Sanitization des inputs utilisateur
           - Protection contre prompt injection
           - Limitation de tokens/longueur

        2. **Donn√©es Sensibles**:
           - Pas de PII dans les prompts
           - Masquage des donn√©es confidentielles
           - Conformit√© RGPD

        3. **Rate Limiting**:
           - Protection contre abus API IA
           - Gestion des co√ªts
           - Quotas par utilisateur

        4. **Error Handling**:
           - Fallback si API IA indisponible
           - Pas de leak de la logique IA

        5. **Performance**:
           - Timeouts appropri√©s
           - Streaming vs batch
           - Caching si pertinent

    # Authentication Functions
    - path: "supabase/functions/delete-account/**"
      instructions: |
        üî¥ CRITIQUE - Suppression Compte

        V√©rifier:
        1. Auth JWT obligatoire
        2. Confirmation utilisateur
        3. Soft delete vs hard delete
        4. Cascade deletion des donn√©es
        5. Audit log
        6. RGPD compliance (droit √† l'oubli)

    - path: "supabase/functions/send-access-info/**"
      instructions: |
        üî¥ Envoi Informations Acc√®s

        S'assurer:
        1. Pas de credentials en clair
        2. Expiration des tokens
        3. Canal de communication s√©curis√©
        4. Rate limiting (pr√©vention brute force)

    # Shared Utilities - Security Foundation
    - path: "supabase/functions/_shared/**"
      instructions: |
        üî¥ Modules Partag√©s - Foundation S√©curit√©

        Analyser:
        1. **webhook-security.ts**:
           - Impl√©mentation HMAC correcte
           - Timing attack prevention
           - Rate limiting robuste

        2. **normalize-phone.ts**:
           - Validation format international
           - Prevention injection

        3. **timezone-helpers.ts**:
           - Gestion correcte DST et edge cases
           - Pas de timezone confusion bugs

    # Frontend Authentication & Sensitive Data
    - path: "src/pages/Auth.tsx"
      instructions: |
        üî¥ Page Authentification

        V√©rifier:
        1. Pas de credentials stock√©s en clair
        2. HTTPS only
        3. Protection CSRF
        4. Input validation (email, password)
        5. Rate limiting c√¥t√© client
        6. Gestion s√©curis√©e des tokens

    - path: "src/pages/ForgotPassword.tsx"
      instructions: |
        ‚ö†Ô∏è Reset Password Flow

        S'assurer:
        1. Email validation
        2. Rate limiting
        3. Pas d'√©num√©ration utilisateurs
        4. Token expiration

    - path: "src/pages/ResetPassword.tsx"
      instructions: |
        ‚ö†Ô∏è Reset Password Execution

        V√©rifier:
        1. Token validation c√¥t√© serveur
        2. Password strength enforcement
        3. Token usage unique
        4. Expiration handling

    # Supabase Client Configuration
    - path: "src/integrations/supabase/client.ts"
      instructions: |
        üî¥ CRITIQUE - Supabase Client Config

        Analyser:
        1. Pas de anon key expos√©e si non n√©cessaire
        2. RLS (Row Level Security) enforcement
        3. Pas de service_role key c√¥t√© client
        4. Proper auth persistence
        5. Error handling

    - path: "src/integrations/supabase/types.ts"
      instructions: |
        Type Safety - Supabase Types

        V√©rifier:
        1. Types √† jour avec le sch√©ma DB
        2. Pas de 'any' non justifi√©s
        3. Null safety

    # Custom Hooks - Data Handling
    - path: "src/hooks/**"
      instructions: |
        ‚ö†Ô∏è Custom Hooks - Data Flow

        Analyser:
        1. Gestion erreurs appropri√©e
        2. Loading states
        3. Memory leaks (useEffect cleanup)
        4. Stale data handling
        5. Optimistic updates s√©curis√©s

    # Message Handling - Privacy
    - path: "src/pages/Messages.tsx"
      instructions: |
        üî¥ Messages - Confidentialit√©

        V√©rifier:
        1. Chiffrement end-to-end si applicable
        2. Pas de log des messages
        3. XSS prevention dans le rendu
        4. Rate limiting
        5. Validation des pi√®ces jointes

    - path: "src/components/messages/**"
      instructions: |
        ‚ö†Ô∏è Composants Messages

        S'assurer:
        1. Sanitization du contenu
        2. Pas de render de HTML non s√©curis√©
        3. Protection contre injection

    # Appointments - Business Logic
    - path: "src/pages/Appointments.tsx"
      instructions: |
        ‚ö†Ô∏è Rendez-vous - Logic M√©tier

        Analyser:
        1. Validation timezone
        2. Double booking prevention
        3. Date validation (past dates, etc.)
        4. Concurrency handling

    - path: "src/components/availability/**"
      instructions: |
        Disponibilit√©s - Edge Cases

        V√©rifier:
        1. Midnight-crossing ranges (d√©j√† fix√©?)
        2. DST handling
        3. Overlap detection

    # Components UI - XSS & Accessibility
    - path: "src/components/ui/**"
      instructions: |
        UI Components - shadcn/ui

        V√©rifier basique:
        1. Props validation
        2. XSS dans les props dynamiques
        3. Accessibility (a11y)

    # Environment & Config
    - path: ".env*"
      instructions: |
        üî¥ CRITIQUE - Variables d'environnement

        S'assurer:
        1. Pas de secrets committ√©s
        2. .env dans .gitignore
        3. Documentation des vars requises

    - path: "vite.config.ts"
      instructions: |
        Build Configuration

        V√©rifier:
        1. Source maps d√©sactiv√©es en prod
        2. Minification activ√©e
        3. Pas de dev tools en prod

  # Review settings
  review_status: true
  poem: false  # No poem, just facts
  collapse_walkthrough: false  # Show full walkthrough

  # Early access features
  early_access: true

  # Tone for French comments
  tone_instructions: |
    Utiliser un ton professionnel et direct en fran√ßais.
    - √ätre pr√©cis et factuel
    - Citer le code concern√©
    - Proposer des solutions concr√®tes
    - Classer par priorit√©: üî¥ Critique | ‚ö†Ô∏è Important | üí° Suggestion

# Chat settings
chat:
  auto_reply: true

# Knowledge base (optional)
knowledge_base:
  enabled: true

  learnings:
    scope: "global"  # Learn from this review for future

  # Opt-in to learn from this codebase
  opt_out: false

# Exclude paths not relevant for review
exclude_patterns:
  - "node_modules/**"
  - "dist/**"
  - "build/**"
  - ".lovable/**"
  - "*.lock"
  - "*.log"
  - "package-lock.json"
  - "bun.lockb"
  - ".git/**"
  - "*.md"  # Documentation (except security-related)
  - "*.svg"
  - "*.png"
  - "*.jpg"
  - "*.jpeg"
  - "*.gif"
  - "*.ico"
  - "public/**"  # Static assets
  - "*.test.ts"
  - "*.test.tsx"
  - "*.spec.ts"
  - "*.spec.tsx"

# Include important config files
include_patterns:
  - "**/*.ts"
  - "**/*.tsx"
  - "**/*.js"
  - "**/*.jsx"
  - "supabase/config.toml"
  - "vite.config.ts"
  - "tsconfig*.json"
  - ".env.example"
